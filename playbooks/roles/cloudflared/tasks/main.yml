---
- name: Disable IPv6 system-wide
  sysctl:
    name: net.ipv6.conf.all.disable_ipv6
    value: 1
    state: present
    sysctl_set: yes
    reload: yes

- name: Disable IPv6 on default interface
  sysctl:
    name: net.ipv6.conf.default.disable_ipv6
    value: 1
    state: present
    sysctl_set: yes
    reload: yes

- name: Ensure cloudflared config directory exists
  file:
    path: "{{ cloudflared_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Deploy cloudflared config.yml
  template:
    src: cloudflared-config.yml.j2
    dest: "{{ cloudflared_config_dir }}/config.yml"
    owner: root
    group: root
    mode: '0644'

- name: Deploy cloudflared tunnel credentials
  copy:
    dest: "{{ cloudflared_config_dir }}/{{ cloudflared_tunnel_id }}.json"
    content: "{{ vault_cloudflared_credentials | to_nice_json }}"
    owner: root
    group: root
    mode: '0644'

- name: Ensure credentials file is readable by container user
  file:
    path: "{{ cloudflared_config_dir }}/{{ cloudflared_tunnel_id }}.json"
    mode: '0644'
    owner: root
    group: root

- name: Run Cloudflared as a Docker container
  community.docker.docker_container:
    name: cloudflared
    image: cloudflare/cloudflared:latest
    restart_policy: unless-stopped
    command: tunnel run {{ cloudflared_tunnel_id }}
    volumes:
      - "{{ cloudflared_config_dir }}:/etc/cloudflared"
    networks:
      - name: "{{ traefik_network }}"
    # fallback safeguard: run as root if non-root fails
    user: "{{ cloudflared_user | default('65532') }}"
