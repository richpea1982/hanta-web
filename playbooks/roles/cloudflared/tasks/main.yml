---
# Ensure networks exist
- name: Ensure proxy network exists
  community.docker.docker_network:
    name: "{{ traefik_network }}"
    state: present

- name: Ensure backend network exists
  community.docker.docker_network:
    name: "{{ backend_network }}"
    state: present

- name: Ensure monitoring network exists
  community.docker.docker_network:
    name: "{{ monitoring_network }}"
    state: present

# Disable IPv6 system-wide
- name: Disable IPv6 system-wide
  sysctl:
    name: net.ipv6.conf.all.disable_ipv6
    value: 1
    state: present
    sysctl_set: yes
    reload: yes

- name: Disable IPv6 on default interface
  sysctl:
    name: net.ipv6.conf.default.disable_ipv6
    value: 1
    state: present
    sysctl_set: yes
    reload: yes

# Cloudflared setup
- name: Ensure cloudflared config directory exists
  file:
    path: "{{ cloudflared_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

# Step 1: Create tunnel with a one-time init container
- name: Create Cloudflare tunnel (one-time)
  community.docker.docker_container:
    name: cloudflared-init
    image: cloudflare/cloudflared:latest
    command: tunnel create {{ cloudflared_tunnel_name }}
    volumes:
      - "{{ cloudflared_config_dir }}:/etc/cloudflared"
    networks:
      - name: "{{ traefik_network }}"
    user: "{{ cloudflared_user }}"
    state: started

- name: Remove init container
  community.docker.docker_container:
    name: cloudflared-init
    state: absent

# Step 2: Run the persistent tunnel container
- name: Run Cloudflared tunnel
  community.docker.docker_container:
    name: cloudflared
    image: cloudflare/cloudflared:latest
    restart_policy: unless-stopped
    command: tunnel run {{ cloudflared_tunnel_name }}
    volumes:
      - "{{ cloudflared_config_dir }}:/etc/cloudflared"
    networks:
      - name: "{{ traefik_network }}"
    user: "{{ cloudflared_user }}"

- name: Create DNS record for Portainer
  uri:
    url: "https://api.cloudflare.com/client/v4/zones/{{ cloudflare_zone_id }}/dns_records"
    method: POST
    headers:
      Authorization: "Bearer {{ vault_cloudflare_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: CNAME
      name: "portainer.pearsalls.online"
      content: "f77ee1ff-0c1d-4883-a922-4800456af1c5.cfargotunnel.com"
      proxied: true
